<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bank - Dice Game</title>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      color: #333;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    h1 {
      text-align: center;
      color: #667eea;
      margin-bottom: 30px;
      font-size: 2.5em;
    }
    .screen { display: none; }
    .screen.active { display: block; }
    
    /* Join/Create Screen */
    .join-controls {
      display: flex;
      flex-direction: column;
      gap: 15px;
      max-width: 400px;
      margin: 0 auto;
    }
    input {
      padding: 15px;
      font-size: 16px;
      border: 2px solid #ddd;
      border-radius: 10px;
      outline: none;
      transition: border 0.3s;
    }
    input:focus { border-color: #667eea; }
    button {
      padding: 15px 30px;
      font-size: 16px;
      font-weight: bold;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s;
      color: white;
    }
    button:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    .btn-primary:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4); }
    .btn-success { background: #10b981; }
    .btn-success:hover:not(:disabled) { background: #059669; }
    .btn-danger { background: #ef4444; }
    .btn-danger:hover:not(:disabled) { background: #dc2626; }
    .btn-secondary { background: #6b7280; }
    .btn-secondary:hover:not(:disabled) { background: #4b5563; }
    .btn-dice { 
      background: #3b82f6;
      min-width: 60px;
      padding: 12px 20px;
      font-size: 1.2em;
    }
    .btn-dice:hover:not(:disabled) { background: #2563eb; }
    
    /* Waiting Room */
    .room-code {
      text-align: center;
      margin: 20px 0;
      padding: 20px;
      background: #f3f4f6;
      border-radius: 10px;
    }
    .room-code h2 { color: #667eea; font-size: 3em; letter-spacing: 5px; }
    .player-list {
      margin: 20px 0;
      padding: 20px;
      background: #f9fafb;
      border-radius: 10px;
    }
    .player-item {
      padding: 10px;
      margin: 5px 0;
      background: white;
      border-radius: 5px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .rounds-config {
      margin: 20px 0;
      padding: 20px;
      background: #f3f4f6;
      border-radius: 10px;
      text-align: center;
    }
    .rounds-config label {
      display: block;
      margin-bottom: 10px;
      font-weight: bold;
      color: #667eea;
    }
    .rounds-config input {
      width: 100px;
      text-align: center;
      font-size: 1.5em;
    }
    
    /* Game Screen */
    .game-header {
      text-align: center;
      margin-bottom: 20px;
      padding: 20px;
      background: #f3f4f6;
      border-radius: 10px;
    }
    .round-info { font-size: 1.2em; color: #6b7280; margin-bottom: 10px; }
    .shared-score {
      font-size: 4em;
      font-weight: bold;
      color: #667eea;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
    }
    .roll-count { color: #6b7280; margin-top: 5px; }
    
    .last-roll {
      margin-top: 15px;
      padding: 15px;
      background: white;
      border-radius: 10px;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 15px;
    }
    .dice-display {
      width: 60px;
      height: 60px;
      background: white;
      border: 3px solid #667eea;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2em;
      font-weight: bold;
      color: #667eea;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .dice-separator {
      font-size: 2em;
      color: #6b7280;
    }
    .dice-total {
      padding: 10px 20px;
      background: #667eea;
      color: white;
      border-radius: 8px;
      font-weight: bold;
      font-size: 1.2em;
    }
    
    .sort-controls {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-bottom: 15px;
    }
    .sort-btn {
      padding: 8px 15px;
      font-size: 0.9em;
      background: #e5e7eb;
      color: #374151;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
    }
    .sort-btn.active {
      background: #667eea;
      color: white;
    }
    .sort-btn:hover:not(.active) {
      background: #d1d5db;
    }
    
    .players-grid {
      display: grid;
      gap: 10px;
      margin: 20px 0;
    }
    .player-card {
      padding: 15px;
      background: #f9fafb;
      border-radius: 10px;
      border-left: 4px solid #ddd;
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 10px;
    }
    .player-card.active { border-left-color: #667eea; background: #ede9fe; }
    .player-card.banked { border-left-color: #10b981; background: #d1fae5; }
    .player-name { font-weight: bold; font-size: 1.1em; }
    .player-scores { font-size: 0.9em; color: #6b7280; }
    .player-status {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .badge {
      padding: 5px 10px;
      border-radius: 5px;
      font-size: 0.8em;
      font-weight: bold;
    }
    .badge-success { background: #10b981; color: white; }
    .badge-info { background: #3b82f6; color: white; }
    
    .action-area {
      margin: 20px 0;
      padding: 20px;
      background: #f3f4f6;
      border-radius: 10px;
      text-align: center;
    }
    
    .dice-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      margin: 15px 0;
    }
    
    .toggle-input-mode {
      margin-bottom: 15px;
    }
    
    .host-controls {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-top: 20px;
    }
    
    .error-message {
      background: #fee2e2;
      color: #dc2626;
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
      text-align: center;
    }
    
    /* End Screen */
    .winner-announcement {
      text-align: center;
      padding: 30px;
      background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
      border-radius: 10px;
      margin: 20px 0;
      color: white;
    }
    .winner-announcement h2 { font-size: 2.5em; margin-bottom: 10px; }
    .final-scores {
      margin: 20px 0;
    }
    .score-item {
      padding: 15px;
      margin: 10px 0;
      background: #f9fafb;
      border-radius: 10px;
      display: flex;
      justify-content: space-between;
      font-size: 1.2em;
    }
    .score-item:first-child {
      background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
      color: white;
      font-weight: bold;
      font-size: 1.5em;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üé≤ Bank</h1>
    
    <!-- Join/Create Screen -->
    <div id="joinScreen" class="screen active">
      <div class="join-controls">
        <input type="text" id="playerName" placeholder="Enter your name" maxlength="20">
        <button class="btn-primary" onclick="createRoom()">Create New Game</button>
        <div style="text-align: center; margin: 10px 0;">‚Äî OR ‚Äî</div>
        <input type="text" id="roomCodeInput" placeholder="Enter room code" maxlength="4" style="text-transform: uppercase;">
        <button class="btn-secondary" onclick="joinRoom()">Join Game</button>
      </div>
      <div id="errorMsg" class="error-message" style="display: none;"></div>
    </div>
    
    <!-- Waiting Room -->
    <div id="waitingScreen" class="screen">
      <div class="room-code">
        <p>Room Code</p>
        <h2 id="displayRoomCode"></h2>
        <p style="margin-top: 10px; color: #6b7280;">Share this code with friends!</p>
      </div>
      
      <div class="rounds-config" id="roundsConfig" style="display: none;">
        <label for="totalRoundsInput">Number of Rounds:</label>
        <input type="number" id="totalRoundsInput" min="1" max="50" value="20" onchange="setRounds()">
      </div>
      
      <div class="player-list">
        <h3 style="margin-bottom: 15px;">Players</h3>
        <div id="waitingPlayerList"></div>
      </div>
      <div style="text-align: center;">
        <button id="startGameBtn" class="btn-success" onclick="startGame()" style="display: none;">Start Game</button>
      </div>
    </div>
    
    <!-- Game Screen -->
    <div id="gameScreen" class="screen">
      <div class="game-header">
        <div class="round-info">Round <span id="currentRound">1</span> / <span id="totalRounds">20</span></div>
        <div class="shared-score" id="sharedScore">0</div>
        <div class="roll-count">Roll <span id="rollCount">0</span></div>
        <div class="last-roll" id="lastRollDisplay" style="display: none;">
          <div class="dice-display" id="die1Display">?</div>
          <div class="dice-separator">+</div>
          <div class="dice-display" id="die2Display">?</div>
          <div class="dice-separator">=</div>
          <div class="dice-total" id="diceTotal">?</div>
        </div>
      </div>
      
      <div class="sort-controls">
        <button class="sort-btn active" onclick="setSortMode('turn')" id="sortTurnBtn">Turn Order</button>
        <button class="sort-btn" onclick="setSortMode('locked')" id="sortLockedBtn">By Locked Score</button>
        <button class="sort-btn" onclick="setSortMode('projected')" id="sortProjectedBtn">By Projected Score</button>
      </div>
      
      <div class="players-grid" id="playerCards"></div>
      
      <!-- Host dice mode toggle (always visible to host during game) -->
      <div id="hostDiceToggle" style="display: none; text-align: center; margin: 20px 0; padding: 15px; background: #f3f4f6; border-radius: 10px;">
        <button class="btn-secondary" onclick="toggleInputMode()" id="toggleModeBtn">Use Physical Dice</button>
      </div>
      
      <div class="action-area">
        <div id="yourTurnArea" style="display: none;">
          <h3>Your Turn!</h3>
          
          <!-- Virtual dice roll -->
          <div id="virtualDiceArea">
            <button class="btn-primary" onclick="rollDice()" style="font-size: 1.5em; padding: 20px 40px;">üé≤ Roll Dice</button>
          </div>
          
          <!-- Physical dice prompt -->
          <div id="physicalDiceArea" style="display: none;">
            <!-- For host: show input buttons -->
            <div id="physicalDiceHost" style="display: none;">
              <div style="padding: 20px; background: white; border-radius: 10px; border: 2px dashed #667eea;">
                <p style="font-size: 1.3em; color: #667eea; margin-bottom: 15px; font-weight: bold;">Enter the dice roll:</p>
                <div class="dice-buttons" id="diceButtons"></div>
              </div>
            </div>
            
            <!-- For regular players: simple message -->
            <div id="physicalDicePlayer" style="display: none;">
              <div style="padding: 40px; background: white; border-radius: 10px; border: 3px solid #667eea; text-align: center;">
                <p style="font-size: 2em; color: #667eea; margin-bottom: 10px;">üé≤</p>
                <p style="font-size: 1.5em; color: #667eea; font-weight: bold; margin-bottom: 10px;">Roll the Dice!</p>
                <p style="color: #6b7280; font-size: 1.1em;">Wait for the host to enter your result</p>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Host physical dice input area (shown when it's NOT host's turn but physical dice enabled) -->
        <div id="hostPhysicalInputArea" style="display: none;">
          <div style="padding: 20px; background: white; border-radius: 10px; border: 2px solid #667eea; margin-bottom: 15px;">
            <p style="font-size: 1.2em; color: #667eea; margin-bottom: 10px; font-weight: bold;">
              <span id="currentPlayerForHost"></span>'s Turn
            </p>
            <p style="color: #6b7280; margin-bottom: 15px;">Enter their dice roll:</p>
            <div class="dice-buttons" id="diceButtonsForOthers"></div>
          </div>
        </div>
        
        <div id="bankArea" style="display: none;">
          <button class="btn-success" onclick="bank()">üè¶ Bank Now</button>
        </div>
        
        <div id="waitingArea">
          <p style="color: #6b7280;">Waiting for <span id="currentPlayerName"></span>...</p>
        </div>
      </div>
      
      <div class="host-controls" id="hostControls" style="display: none;">
        <button class="btn-secondary" onclick="nextTurn()" id="nextTurnBtn">Next Turn ‚Üí</button>
        <button class="btn-success" onclick="nextTurn()" id="nextRoundBtn" style="display: none;">Start Next Round ‚Üí</button>
        <button class="btn-danger" onclick="undo()">‚Ü∂ Undo</button>
      </div>
    </div>
    
    <!-- End Screen -->
    <div id="endScreen" class="screen">
      <div class="winner-announcement">
        <h2>üèÜ</h2>
        <h2 id="winnerName">Winner</h2>
      </div>
      <div class="final-scores" id="finalScores"></div>
      <div style="text-align: center; margin-top: 20px;">
        <button class="btn-primary" onclick="location.reload()">New Game</button>
      </div>
    </div>
  </div>

  <script>
    const socket = io();
    let gameState = null;
    let myId = null;
    let isHost = false;
    let sortMode = 'turn'; // 'turn', 'locked', or 'projected'
    let currentRoomCode = null;

    // Load saved session from localStorage
    function loadSession() {
      const savedSession = localStorage.getItem('bankGameSession');
      if (savedSession) {
        const session = JSON.parse(savedSession);
        return session;
      }
      return null;
    }

    // Save session to localStorage
    function saveSession(roomCode, playerId) {
      localStorage.setItem('bankGameSession', JSON.stringify({
        roomCode,
        playerId,
        timestamp: Date.now()
      }));
    }

    // Clear session
    function clearSession() {
      localStorage.removeItem('bankGameSession');
    }

    // Try to reconnect on load
    window.addEventListener('load', () => {
      const session = loadSession();
      if (session) {
        // Check if session is less than 5 minutes old
        if (Date.now() - session.timestamp < 300000) {
          console.log('Attempting to reconnect...', session);
          socket.emit('reconnect_player', {
            roomCode: session.roomCode,
            playerId: session.playerId
          });
        } else {
          clearSession();
        }
      }
    });

    // Join/Create functions
    function createRoom() {
      const name = document.getElementById('playerName').value.trim();
      if (!name) {
        showError('Please enter your name');
        return;
      }
      socket.emit('create_room', { playerName: name });
    }

    function joinRoom() {
      const name = document.getElementById('playerName').value.trim();
      const code = document.getElementById('roomCodeInput').value.trim().toUpperCase();
      if (!name || !code) {
        showError('Please enter your name and room code');
        return;
      }
      socket.emit('join_room', { roomCode: code, playerName: name });
    }

    function setRounds() {
      const rounds = parseInt(document.getElementById('totalRoundsInput').value);
      socket.emit('set_rounds', { totalRounds: rounds });
    }

    function startGame() {
      socket.emit('start_game');
    }

    function setSortMode(mode) {
      sortMode = mode;
      
      // Update button states
      document.getElementById('sortTurnBtn').classList.toggle('active', mode === 'turn');
      document.getElementById('sortLockedBtn').classList.toggle('active', mode === 'locked');
      document.getElementById('sortProjectedBtn').classList.toggle('active', mode === 'projected');
      
      // Re-render player list with new sort
      if (gameState) {
        updateGameScreen(gameState);
      }
    }

    function toggleInputMode() {
      socket.emit('toggle_dice_mode');
    }

    function updateInputMode() {
      if (!gameState) return;
      
      const usePhysicalDice = gameState.gameState.usePhysicalDice;
      const toggleBtn = document.getElementById('toggleModeBtn');
      const hostToggleArea = document.getElementById('hostDiceToggle');
      
      if (!toggleBtn) return;
      
      // Update toggle button text
      if (usePhysicalDice) {
        toggleBtn.textContent = 'Use Virtual Dice';
      } else {
        toggleBtn.textContent = 'Use Physical Dice';
      }
      
      // Show toggle for host only during active game
      if (hostToggleArea) {
        hostToggleArea.style.display = (isHost && gameState.gameState.status === 'playing') ? 'block' : 'none';
      }
    }

    function renderDiceButtons() {
      const rollCount = gameState.gameState.rollCount;
      
      // Determine which container to use
      const containers = [
        document.getElementById('diceButtons'),
        document.getElementById('diceButtonsForOthers')
      ];
      
      containers.forEach(container => {
        if (!container) return;
        
        if (rollCount < 3) {
          // First 3 rolls: 2-12 with 7 special
          const buttons = [];
          for (let i = 2; i <= 12; i++) {
            const label = i === 7 ? '7 (+70)' : i.toString();
            buttons.push(`<button class="btn-dice" onclick="submitPhysicalDice(${i}, false)">${label}</button>`);
          }
          container.innerHTML = buttons.join('');
        } else {
          // After 3 rolls: 3-11, 7 kills, doubles
          const buttons = [];
          
          // 2 and 12 disabled
          buttons.push(`<button class="btn-dice" disabled style="opacity: 0.3;">2</button>`);
          
          for (let i = 3; i <= 11; i++) {
            if (i === 7) {
              buttons.push(`<button class="btn-dice btn-danger" onclick="submitPhysicalDice(${i}, false)">7 (üíÄ)</button>`);
            } else {
              buttons.push(`<button class="btn-dice" onclick="submitPhysicalDice(${i}, false)">${i}</button>`);
            }
          }
          
          buttons.push(`<button class="btn-dice" disabled style="opacity: 0.3;">12</button>`);
          buttons.push(`<button class="btn-dice btn-success" onclick="submitPhysicalDice(0, true)" style="grid-column: span 2;">Doubles (√ó2)</button>`);
          
          container.innerHTML = buttons.join('');
        }
      });
    }

    // Game actions
    function rollDice() {
      socket.emit('roll_dice');
    }

    function submitPhysicalDice(value, isDoubles) {
      socket.emit('submit_physical_dice', { value, isDoubles });
    }

    function bank() {
      socket.emit('bank');
    }

    function nextTurn() {
      socket.emit('next_turn');
    }

    function undo() {
      socket.emit('undo');
    }

    // Socket listeners
    socket.on('room_created', ({ roomCode, playerId }) => {
      console.log('Room created, my ID:', playerId);
      myId = playerId;
      isHost = true;
      currentRoomCode = roomCode;
      saveSession(roomCode, playerId);
      document.getElementById('displayRoomCode').textContent = roomCode;
      showScreen('waitingScreen');
    });

    socket.on('reconnected', ({ playerId }) => {
      console.log('Successfully reconnected as:', playerId);
      myId = playerId;
      // Game state update will come next and show the correct screen
    });

    socket.on('game_state_update', (room) => {
      console.log('Game state update received:', room);
      console.log('My ID:', myId, 'Socket ID:', socket.id);
      
      gameState = room;
      currentRoomCode = room.roomCode;
      
      // Set myId if not already set
      if (!myId) {
        myId = socket.id;
      }
      
      // Save session when joining a room
      if (room.players.find(p => p.id === myId)) {
        saveSession(room.roomCode, myId);
      }
      
      isHost = room.hostId === myId;
      
      if (room.gameState.status === 'waiting') {
        updateWaitingRoom(room);
      } else if (room.gameState.status === 'playing') {
        updateGameScreen(room);
      } else if (room.gameState.status === 'finished') {
        updateEndScreen(room);
      }
    });

    socket.on('error', ({ message }) => {
      showError(message);
    });

    // UI update functions
    function updateWaitingRoom(room) {
      showScreen('waitingScreen');
      document.getElementById('displayRoomCode').textContent = room.roomCode;
      document.getElementById('totalRoundsInput').value = room.gameState.totalRounds;
      
      const list = document.getElementById('waitingPlayerList');
      list.innerHTML = room.players.map((p, i) => `
        <div class="player-item">
          <span>${p.name} ${p.id === room.hostId ? '(Host)' : ''}</span>
        </div>
      `).join('');
      
      document.getElementById('startGameBtn').style.display = isHost ? 'block' : 'none';
      document.getElementById('roundsConfig').style.display = isHost ? 'block' : 'none';
    }

    function updateGameScreen(room) {
      showScreen('gameScreen');
      
      document.getElementById('currentRound').textContent = room.gameState.currentRound;
      document.getElementById('totalRounds').textContent = room.gameState.totalRounds;
      document.getElementById('sharedScore').textContent = room.gameState.sharedRoundScore;
      document.getElementById('rollCount').textContent = room.gameState.rollCount;
      
      // Display last roll
      if (room.gameState.lastRoll) {
        const lastRollEl = document.getElementById('lastRollDisplay');
        lastRollEl.style.display = 'flex';
        
        if (room.gameState.lastRoll.die1 !== null) {
          document.getElementById('die1Display').textContent = room.gameState.lastRoll.die1;
          document.getElementById('die2Display').textContent = room.gameState.lastRoll.die2;
        } else {
          document.getElementById('die1Display').textContent = '?';
          document.getElementById('die2Display').textContent = '?';
        }
        document.getElementById('diceTotal').textContent = room.gameState.lastRoll.total;
      } else {
        document.getElementById('lastRollDisplay').style.display = 'none';
      }
      
      const currentPlayer = room.players[room.gameState.currentTurnIndex];
      
      // Sort players based on current sort mode
      let sortedPlayers = [...room.players];
      if (sortMode === 'locked') {
        sortedPlayers.sort((a, b) => b.lockedScore - a.lockedScore);
      } else if (sortMode === 'projected') {
        sortedPlayers.sort((a, b) => {
          const aProj = a.bankedThisRound ? a.lockedScore : a.lockedScore + room.gameState.sharedRoundScore;
          const bProj = b.bankedThisRound ? b.lockedScore : b.lockedScore + room.gameState.sharedRoundScore;
          return bProj - aProj;
        });
      }
      // else sortMode === 'turn', keep original order
      
      // Player cards
      const cardsHtml = sortedPlayers.map((p, index) => {
        const isCurrent = p.id === currentPlayer.id;
        const projectedScore = p.bankedThisRound ? p.lockedScore : p.lockedScore + room.gameState.sharedRoundScore;
        const isDisconnected = p.disconnected;
        
        return `
          <div class="player-card ${isCurrent ? 'active' : ''} ${p.bankedThisRound ? 'banked' : ''}">
            <div>
              <div class="player-name">${sortMode === 'turn' ? '' : (index + 1) + '. '}${p.name}${isDisconnected ? ' (Disconnected)' : ''}</div>
              <div class="player-scores">
                Locked: ${p.lockedScore} | Projected: ${projectedScore}
              </div>
            </div>
            <div class="player-status">
              ${p.bankedThisRound ? '<span class="badge badge-success">BANKED</span>' : ''}
              ${isCurrent ? '<span class="badge badge-info">TURN</span>' : ''}
              ${isDisconnected ? '<span class="badge" style="background: #ef4444; color: white;">OFFLINE</span>' : ''}
            </div>
          </div>
        `;
      }).join('');
      document.getElementById('playerCards').innerHTML = cardsHtml;
      
      // Update host toggle button visibility and state
      updateInputMode();
      
      // Action area
      const isMyTurn = currentPlayer.id === myId;
      const myPlayer = room.players.find(p => p.id === myId);
      const usePhysicalDice = room.gameState.usePhysicalDice;
      
      // Can't roll if you've already banked OR if round is not active
      const canRoll = isMyTurn && room.gameState.roundActive && !myPlayer.bankedThisRound;
      
      // Can bank if: not banked yet, at least 3 rolls done, round is still active
      const canBank = myPlayer && !myPlayer.bankedThisRound && 
                      room.gameState.rollCount >= 3 && 
                      room.gameState.roundActive;
      
      // Show/hide main action areas
      document.getElementById('yourTurnArea').style.display = canRoll ? 'block' : 'none';
      document.getElementById('bankArea').style.display = canBank ? 'block' : 'none';
      
      // Update input mode for player's turn
      if (canRoll) {
        const virtualArea = document.getElementById('virtualDiceArea');
        const physicalArea = document.getElementById('physicalDiceArea');
        const physicalHost = document.getElementById('physicalDiceHost');
        const physicalPlayer = document.getElementById('physicalDicePlayer');
        
        if (usePhysicalDice) {
          virtualArea.style.display = 'none';
          physicalArea.style.display = 'block';
          
          if (isHost) {
            physicalHost.style.display = 'block';
            physicalPlayer.style.display = 'none';
            renderDiceButtons();
          } else {
            physicalHost.style.display = 'none';
            physicalPlayer.style.display = 'block';
          }
        } else {
          virtualArea.style.display = 'block';
          physicalArea.style.display = 'none';
        }
      }
      
      // Host physical dice input area (when it's NOT their turn but physical mode is on)
      const hostPhysicalInputArea = document.getElementById('hostPhysicalInputArea');
      if (hostPhysicalInputArea) {
        const showHostInput = isHost && !isMyTurn && usePhysicalDice && room.gameState.roundActive;
        hostPhysicalInputArea.style.display = showHostInput ? 'block' : 'none';
        
        if (showHostInput) {
          document.getElementById('currentPlayerForHost').textContent = currentPlayer.name;
          renderDiceButtons();
        }
      }
      
      // Determine what waiting message to show
      const shouldWait = !canRoll && !(isHost && usePhysicalDice && room.gameState.roundActive);
      document.getElementById('waitingArea').style.display = shouldWait ? 'block' : 'none';
      
      // Update waiting message based on state
      if (myPlayer.bankedThisRound) {
        // Player has banked - waiting for others
        document.getElementById('waitingArea').innerHTML = '<p style="color: #10b981; font-weight: bold;">You\'ve banked! Waiting for others...</p>';
      } else if (!room.gameState.roundActive) {
        // Round is over - waiting for next round
        document.getElementById('waitingArea').innerHTML = '<p style="color: #f59e0b; font-weight: bold;">Round Over - Waiting for next round...</p>';
      } else if (!isMyTurn && !(isHost && usePhysicalDice)) {
        // Not your turn - waiting for current player (unless host in physical mode)
        document.getElementById('waitingArea').innerHTML = `<p style="color: #6b7280;">Waiting for ${currentPlayer.name}...</p>`;
      }
      
      // Host controls
      if (isHost) {
        document.getElementById('hostControls').style.display = 'flex';
        
        // Show appropriate button based on round state
        if (!room.gameState.roundActive) {
          // Round is over - show "Start Next Round" button
          document.getElementById('nextTurnBtn').style.display = 'none';
          document.getElementById('nextRoundBtn').style.display = 'block';
        } else {
          // Round is active - show "Next Turn" button
          document.getElementById('nextTurnBtn').style.display = 'block';
          document.getElementById('nextRoundBtn').style.display = 'none';
        }
      } else {
        document.getElementById('hostControls').style.display = 'none';
      }
    }

    function updateEndScreen(room) {
      showScreen('endScreen');
      
      const sorted = [...room.players].sort((a, b) => b.lockedScore - a.lockedScore);
      document.getElementById('winnerName').textContent = sorted[0].name + ' Wins!';
      
      const scoresHtml = sorted.map((p, i) => `
        <div class="score-item">
          <span>${i + 1}. ${p.name}</span>
          <span>${p.lockedScore} points</span>
        </div>
      `).join('');
      document.getElementById('finalScores').innerHTML = scoresHtml;
    }

    function showScreen(screenId) {
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      document.getElementById(screenId).classList.add('active');
    }

    function showError(msg) {
      const errorEl = document.getElementById('errorMsg');
      errorEl.textContent = msg;
      errorEl.style.display = 'block';
      setTimeout(() => errorEl.style.display = 'none', 3000);
    }
  </script>
</body>
</html>
