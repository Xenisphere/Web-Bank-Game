<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bank - Dice Game</title>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html {
      overscroll-behavior: auto;
      height: 100dvh;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100dvh;
      height: 100dvh;
      padding: 10px;
      color: #333;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: auto;
      overscroll-behavior-y: auto;
    }
    .container {
      max-width: 800px;
      width: 100%;
      height: 100%;
      max-height: 100%;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      padding: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    @media (min-width: 768px) {
      body {
        padding: 20px;
      }
      .container {
        height: 95vh;
        max-height: 900px;
        padding: 30px;
      }
    }
    h1 {
      text-align: center;
      color: #667eea;
      margin-bottom: 30px;
      font-size: 2.5em;
    }
    h1.in-game {
      margin-bottom: 15px;
      font-size: 2em;
    }
    .screen { 
      display: none;
    }
    .screen.active { 
      display: flex;
      flex-direction: column;
      height: 100%;
      overflow: hidden;
    }
    
    /* Join/Create Screen */
    #joinScreen {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }
    #joinScreen:not(.active) {
      display: none !important;
    }
    
    /* Waiting Screen */
    #waitingScreen {
      display: flex;
      flex-direction: column;
      overflow-y: auto;
    }
    #waitingScreen:not(.active) {
      display: none !important;
    }
    
    /* Reconnect Screen */
    #reconnectScreen {
      display: flex;
      flex-direction: column;
      justify-content: center;
    }
    #reconnectScreen:not(.active) {
      display: none !important;
    }
    
    /* End Screen */
    #endScreen {
      display: flex;
      flex-direction: column;
      overflow-y: auto;
    }
    #endScreen:not(.active) {
      display: none !important;
    }
    
    .join-controls {
      display: flex;
      flex-direction: column;
      gap: 15px;
      max-width: 400px;
      width: 100%;
      margin: 0 auto;
    }
    input {
      padding: 15px;
      font-size: 16px;
      border: 2px solid #ddd;
      border-radius: 10px;
      outline: none;
      transition: border 0.3s;
    }
    input:focus { border-color: #667eea; }
    button {
      padding: 15px 30px;
      font-size: 16px;
      font-weight: bold;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s;
      color: white;
      pointer-events: auto;
      position: relative;
      z-index: 1;
    }
    button:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    .btn-primary:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4); }
    .btn-success { background: #10b981; }
    .btn-success:hover:not(:disabled) { background: #059669; }
    .btn-danger { background: #ef4444; }
    .btn-danger:hover:not(:disabled) { background: #dc2626; }
    .btn-secondary { background: #6b7280; }
    .btn-secondary:hover:not(:disabled) { background: #4b5563; }
    .btn-dice { 
      background: #3b82f6;
      min-width: 60px;
      padding: 12px 20px;
      font-size: 1.2em;
    }
    .btn-dice:hover:not(:disabled) { background: #2563eb; }
    
    /* Waiting Room */
    .room-code {
      text-align: center;
      margin: 20px 0;
      padding: 20px;
      background: #f3f4f6;
      border-radius: 10px;
      flex-shrink: 0;
    }
    .room-code h2 { color: #667eea; font-size: 3em; letter-spacing: 5px; }
    .player-list {
      margin: 20px 0;
      padding: 20px;
      background: #f9fafb;
      border-radius: 10px;
      flex: 1;
      overflow-y: auto;
      min-height: 0;
    }
    .player-item {
      padding: 10px;
      margin: 5px 0;
      background: white;
      border-radius: 5px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: default;
    }
    .player-item.draggable {
      cursor: move;
      transition: all 0.2s;
      user-select: none;
      -webkit-user-select: none;
      touch-action: none;
    }
    .player-item.draggable:hover {
      background: #f3f4f6;
      transform: translateX(5px);
    }
    .player-item.dragging {
      opacity: 0.5;
      background: #e0e7ff;
    }
    .player-item.drag-over {
      border-top: 3px solid #667eea;
    }
    .player-item.touch-dragging {
      position: fixed;
      z-index: 1000;
      opacity: 0.8;
      transform: scale(1.05);
      box-shadow: 0 10px 20px rgba(0,0,0,0.3);
    }
    .drag-handle {
      color: #9ca3af;
      margin-right: 10px;
      font-size: 1.2em;
    }
    
    .rounds-config {
      margin: 20px 0;
      padding: 20px;
      background: #f3f4f6;
      border-radius: 10px;
      text-align: center;
      flex-shrink: 0;
    }
    .rounds-config label {
      display: block;
      margin-bottom: 10px;
      font-weight: bold;
      color: #667eea;
    }
    .rounds-config input {
      width: 100px;
      text-align: center;
      font-size: 1.5em;
    }
    
    .waiting-footer {
      flex-shrink: 0;
      margin-top: auto;
    }
    
    /* Game Screen */
    #gameScreen {
      display: flex;
      flex-direction: column;
    }
    #gameScreen:not(.active) {
      display: none !important;
    }
    .game-header {
      text-align: center;
      margin-bottom: 15px;
      padding: 15px;
      background: #f3f4f6;
      border-radius: 10px;
      flex-shrink: 0;
    }
    .round-info { font-size: 1em; color: #6b7280; margin-bottom: 8px; }
    .shared-score {
      font-size: 3em;
      font-weight: bold;
      color: #667eea;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
    }
    .roll-count { color: #6b7280; margin-top: 5px; font-size: 0.9em; }
    
    .roll-button-area {
      margin-top: 15px;
      text-align: center;
    }
    
    .last-roll {
      margin-top: 10px;
      padding: 10px;
      background: white;
      border-radius: 8px;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
    }
    .dice-display {
      width: 45px;
      height: 45px;
      background: white;
      border: 2px solid #667eea;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5em;
      font-weight: bold;
      color: #667eea;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .dice-separator {
      font-size: 1.5em;
      color: #6b7280;
    }
    .dice-total {
      padding: 8px 15px;
      background: #667eea;
      color: white;
      border-radius: 6px;
      font-weight: bold;
      font-size: 1em;
    }
    
    .sort-controls {
      display: flex;
      gap: 8px;
      justify-content: center;
      margin-bottom: 10px;
      flex-shrink: 0;
    }
    .sort-btn {
      padding: 6px 12px;
      font-size: 0.85em;
      background: #e5e7eb;
      color: #374151;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s;
    }
    .sort-btn.active {
      background: #667eea;
      color: white;
    }
    .sort-btn:hover:not(.active) {
      background: #d1d5db;
    }
    
    .players-scroll-container {
      flex: 1;
      overflow-y: auto;
      margin: 10px 0;
      padding-right: 5px;
      min-height: 0;
    }
    
    .players-scroll-container::-webkit-scrollbar {
      width: 8px;
    }
    
    .players-scroll-container::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 10px;
    }
    
    .players-scroll-container::-webkit-scrollbar-thumb {
      background: #667eea;
      border-radius: 10px;
    }
    
    .players-scroll-container::-webkit-scrollbar-thumb:hover {
      background: #5568d3;
    }
    
    .players-grid {
      display: grid;
      gap: 8px;
    }
    .player-card {
      padding: 10px;
      background: #f9fafb;
      border-radius: 8px;
      border-left: 3px solid #ddd;
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 8px;
    }
    .player-card.active { border-left-color: #667eea; background: #ede9fe; }
    .player-card.banked { border-left-color: #10b981; background: #d1fae5; }
    .player-name { font-weight: bold; font-size: 1em; }
    .player-scores { font-size: 0.85em; color: #6b7280; margin-top: 2px; }
    .player-status {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .badge {
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.75em;
      font-weight: bold;
    }
    .badge-success { background: #10b981; color: white; }
    .badge-info { background: #3b82f6; color: white; }
    
    .action-area {
      margin: 10px 0;
      padding: 15px;
      background: #f3f4f6;
      border-radius: 10px;
      text-align: center;
      flex-shrink: 0;
    }
    
    .dice-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: center;
      margin: 10px 0;
    }
    
    .host-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: center;
      margin-top: 15px;
      flex-shrink: 0;
    }
    
    .error-message {
      background: #fee2e2;
      color: #dc2626;
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
      text-align: center;
    }
    
    /* End Screen */
    .winner-announcement {
      text-align: center;
      padding: 30px;
      background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
      border-radius: 10px;
      margin: 20px 0;
      color: white;
      flex-shrink: 0;
    }
    .winner-announcement h2 { font-size: 2.5em; margin-bottom: 10px; }
    .final-scores {
      margin: 20px 0;
      flex: 1;
      overflow-y: auto;
      min-height: 0;
    }
    .score-item {
      padding: 15px;
      margin: 10px 0;
      background: #f9fafb;
      border-radius: 10px;
      display: flex;
      justify-content: space-between;
      font-size: 1.2em;
    }
    .score-item:first-child {
      background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
      color: white;
      font-weight: bold;
      font-size: 1.5em;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 id="gameTitle">üé≤ Bank</h1>
    
    <!-- Join/Create Screen -->
    <div id="joinScreen" class="screen active">
      <div class="join-controls">
        <input type="text" id="playerName" placeholder="Enter your name" maxlength="20">
        <button class="btn-primary" onclick="createRoom()">Create New Game</button>
        <div style="text-align: center; margin: 10px 0;">‚Äî OR ‚Äî</div>
        <input type="text" id="roomCodeInput" placeholder="Enter room code" maxlength="4" style="text-transform: uppercase;">
        <button class="btn-secondary" onclick="joinRoom()">Join Game</button>
      </div>
      <div id="errorMsg" class="error-message" style="display: none;"></div>
    </div>
    
    <!-- Reconnect Screen -->
    <div id="reconnectScreen" class="screen">
      <div style="text-align: center; padding: 20px;">
        <h2 style="color: #667eea; margin-bottom: 20px;">üîÑ Reconnecting...</h2>
        <p style="color: #6b7280; margin-bottom: 30px;">We found your previous session!</p>
        
        <div style="background: #f3f4f6; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
          <p style="margin-bottom: 10px;"><strong>Room:</strong> <span id="reconnectRoomCode" style="color: #667eea; font-size: 1.5em;"></span></p>
          <p><strong>Player:</strong> <span id="reconnectPlayerName"></span></p>
        </div>
        
        <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
          <button class="btn-success" onclick="confirmRejoin()" style="min-width: 150px;">Rejoin Game</button>
          <button class="btn-danger" onclick="leaveSession()" style="min-width: 150px;">Leave Session</button>
        </div>
      </div>
    </div>
    
    <!-- Waiting Room -->
    <div id="waitingScreen" class="screen">
      <div class="room-code">
        <p>Room Code</p>
        <h2 id="displayRoomCode"></h2>
        <p style="margin-top: 10px; color: #6b7280;">Share this code with friends!</p>
      </div>
      
      <div class="rounds-config" id="roundsConfig" style="display: none;">
        <label for="totalRoundsInput">Number of Rounds:</label>
        <input type="number" id="totalRoundsInput" min="1" max="50" value="20" onchange="setRounds()">
      </div>
      
      <div class="player-list">
        <h3 style="margin-bottom: 15px;">Players</h3>
        <div id="waitingPlayerList"></div>
      </div>
      <div class="waiting-footer">
        <div style="text-align: center;">
          <button id="startGameBtn" class="btn-success" onclick="startGame()" style="display: none;">Start Game</button>
        </div>
      </div>
    </div>
    
    <!-- Game Screen -->
    <div id="gameScreen" class="screen">
      <div class="game-header">
        <div class="round-info">Round <span id="currentRound">1</span> / <span id="totalRounds">20</span></div>
        <div class="shared-score" id="sharedScore">0</div>
        <div class="roll-count">Roll <span id="rollCount">0</span></div>
        <div class="last-roll" id="lastRollDisplay" style="display: none;">
          <div class="dice-display" id="die1Display">?</div>
          <div class="dice-separator">+</div>
          <div class="dice-display" id="die2Display">?</div>
          <div class="dice-separator">=</div>
          <div class="dice-total" id="diceTotal">?</div>
        </div>
        
        <!-- Roll button area moved here -->
        <div class="roll-button-area" id="rollButtonArea" style="display: none;">
          <!-- Virtual dice roll -->
          <div id="virtualDiceArea">
            <button class="btn-primary" onclick="rollDice()" id="rollButton" style="font-size: 1.5em; padding: 20px 40px;">üé≤ Roll Dice</button>
          </div>
          
          <!-- Physical dice prompt -->
          <div id="physicalDiceArea" style="display: none;">
            <!-- For host: show input buttons -->
            <div id="physicalDiceHost" style="display: none;">
              <div style="padding: 15px; background: white; border-radius: 8px; border: 2px dashed #667eea;">
                <p style="font-size: 1.1em; color: #667eea; margin-bottom: 10px; font-weight: bold;">Enter the dice roll:</p>
                <div class="dice-buttons" id="diceButtons"></div>
              </div>
            </div>
            
            <!-- For regular players: simple message -->
            <div id="physicalDicePlayer" style="display: none;">
              <div style="padding: 30px; background: white; border-radius: 8px; border: 3px solid #667eea; text-align: center;">
                <p style="font-size: 1.8em; color: #667eea; margin-bottom: 8px;">üé≤</p>
                <p style="font-size: 1.3em; color: #667eea; font-weight: bold; margin-bottom: 8px;">Roll the Dice!</p>
                <p style="color: #6b7280; font-size: 1em;">Wait for the host to enter your result</p>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Host physical dice input area (shown when it's NOT host's turn but physical dice enabled) -->
      <div id="hostPhysicalInputArea" style="display: none; flex-shrink: 0;">
        <div style="padding: 15px; background: white; border-radius: 8px; border: 2px solid #667eea; margin-bottom: 10px;">
          <p style="font-size: 1.1em; color: #667eea; margin-bottom: 8px; font-weight: bold;">
            <span id="currentPlayerForHost"></span>'s Turn
          </p>
          <p style="color: #6b7280; margin-bottom: 10px; font-size: 0.9em;">Enter their dice roll:</p>
          <div class="dice-buttons" id="diceButtonsForOthers"></div>
        </div>
      </div>
      
      <div class="sort-controls">
        <button class="sort-btn active" onclick="setSortMode('turn')" id="sortTurnBtn">Turn Order</button>
        <button class="sort-btn" onclick="setSortMode('locked')" id="sortLockedBtn">By Locked Score</button>
        <button class="sort-btn" onclick="setSortMode('projected')" id="sortProjectedBtn">By Projected Score</button>
      </div>
      
      <div class="players-scroll-container">
        <div class="players-grid" id="playerCards"></div>
      </div>
      
      <div class="action-area">
        <div id="bankArea" style="display: none;">
          <button class="btn-success" onclick="bank()">üè¶ Bank Now</button>
        </div>
        
        <div id="waitingArea">
          <p style="color: #6b7280;">Waiting for <span id="currentPlayerName"></span>...</p>
        </div>
      </div>
      
      <div class="host-controls" id="hostControls" style="display: none;">
        <button class="btn-secondary" onclick="toggleInputMode()" id="toggleModeBtn" style="display: none;">Use Physical Dice</button>
        <button class="btn-secondary" onclick="nextTurn()" id="nextTurnBtn">Next Turn ‚Üí</button>
        <button class="btn-success" onclick="nextTurn()" id="nextRoundBtn" style="display: none;">Start Next Round ‚Üí</button>
        <button class="btn-danger" onclick="undo()">‚Ü∂ Undo</button>
      </div>
    </div>
    
    <!-- End Screen -->
    <div id="endScreen" class="screen">
      <div class="winner-announcement">
        <h2>üèÜ</h2>
        <h2 id="winnerName">Winner</h2>
      </div>
      <div class="final-scores" id="finalScores"></div>
      <div style="text-align: center; margin-top: 20px; flex-shrink: 0;">
        <button class="btn-primary" onclick="location.reload()">New Game</button>
      </div>
    </div>
  </div>

  <script>
    const socket = io();
    let gameState = null;
    let myId = null;
    let isHost = false;
    let sortMode = 'turn'; // 'turn', 'locked', or 'projected'
    let currentRoomCode = null;
    let pendingReconnect = null; // Store session data for reconnect screen
    let cooldownInterval = null; // Countdown timer interval

    // Load saved session from localStorage
    function loadSession() {
      const savedSession = localStorage.getItem('bankGameSession');
      if (savedSession) {
        const session = JSON.parse(savedSession);
        return session;
      }
      return null;
    }

    // Save session to localStorage
    function saveSession(roomCode, playerId, playerName) {
      localStorage.setItem('bankGameSession', JSON.stringify({
        roomCode,
        playerId,
        playerName,
        timestamp: Date.now()
      }));
    }

    // Clear session
    function clearSession() {
      localStorage.removeItem('bankGameSession');
    }

    // Show reconnect screen
    function showReconnectScreen(session) {
      pendingReconnect = session;
      document.getElementById('reconnectRoomCode').textContent = session.roomCode;
      document.getElementById('reconnectPlayerName').textContent = session.playerName || 'Unknown';
      showScreen('reconnectScreen');
    }

    // User confirms rejoin
    function confirmRejoin() {
      if (pendingReconnect) {
        console.log('Attempting to reconnect...', pendingReconnect);
        socket.emit('reconnect_player', {
          roomCode: pendingReconnect.roomCode,
          playerId: pendingReconnect.playerId
        });
      }
    }

    // User chooses to leave session
    function leaveSession() {
      clearSession();
      pendingReconnect = n
